# 数据库原理

## 一 事务(transaction)

事务(transaction)就是一组DML语句组成，这些语句存在逻辑相关性，满足 ACID 特性，这一组DML语句要么全部成功，要么全部失败，是一个整体。

在数据库的世界里，**事务（Transaction）** 是一个核心概念。

简单来说，事务是将一组 SQL 语句逻辑地捆绑在一起，作为一个不可分割的工作单元。

为了让你更透彻地理解，我们可以从以下三个维度来拆解：

### 1. 核心定义：全有或全无

想象你在进行一次**银行转账**：

1. 你点击确认，银行系统从你的账户中扣除 1000 元。
2. 银行系统向收款人的账户中增加 1000 元。

如果步骤 1 成功了，但由于网络中断或断电，步骤 2 失败了，这 1000 元就会凭空消失。

事务的作用就是确保：要么这两个步骤都执行成功（提交，Commit），要么如果其中任何一步失败，系统会自动撤销已执行的操作，让数据回到最初的状态（回滚，Rollback）。

------

### 2. 事务的四大特性 (ACID)

任何成熟的关系型数据库（如 MySQL, PostgreSQL, Oracle）都必须遵循 ACID 原则来保证数据的可靠性：

- **原子性 (Atomicity)：** 
  - 事务是最小的操作单元。整个事务中的所有操作要么全部完成，要么全部不执行。
- **一致性 (Consistency)：** 
  - 事务执行前后，数据库必须处于一致的状态。比如转账前后，两个账户的总额必须保持不变。
- **隔离性 (Isolation)：** 
  - 多个用户并发访问数据库时，一个用户的事务不应受到其他用户事务的干扰。
- **持久性 (Durability)：** 
  - 一旦事务提交，它对数据库中数据的改变就是永久性的，即使发生系统崩溃也不会丢失。

------

### 3. 事务的生命周期

在实际操作中，一个典型的事务流程如下表所示：

| **阶段**          | **说明**                                     |
| ----------------- | -------------------------------------------- |
| **BEGIN / START** | 明确告知数据库：接下来的操作属于同一个事务。 |
| **EXECUTE**       | 执行多条增、删、改的操作。                   |
| **COMMIT**        | 如果一切顺利，永久保存所有更改。             |
| **ROLLBACK**      | 如果中途出错，撤回所有已执行但未提交的操作。 |

```sql
-- 典型的事务控制语句
BEGIN TRANSACTION;  -- 开始事务

UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

COMMIT;  -- 提交事务，使更改永久化
-- 或
ROLLBACK;  -- 回滚事务，撤销所有更改
```

