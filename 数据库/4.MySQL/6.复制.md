# 复制

主从复制/读写分离：提高性能，冗余服务器，数据备份，高可用。

## 主从复制（同步）

主要涉及三个线程：binlog 线程、I/O 线程和 SQL 线程。

1. binlog 线程 ：负责将主服务器上的数据更改写入二进制日志（Binary  log）中。
2. I/O 线程 ：负责从主服务器上读取二进制日志，并写入从服务器的中继日志（Relay log）。
3. SQL 线程 ：负责读取中继日志，解析出主服务器已经执行的数据更改并在从服务器中重放（Replay）。

## 读写分离

主服务器处理写操作、实时性要求比较高的读操作，从服务器处理读操作。

读写分离能提高性能的原因在于：

- 主从服务器负责各自的读和写，极大程度缓解了锁的争用；
- 从服务器可以使用 MyISAM，提升查询性能、节约系统开销；
- 增加冗余，提高可用性。

**读写分离常用代理方式来实现**：代理服务器接收应用层传来的读写请求，然后决定转发到哪个服务器。

## 主从同步目的

1. 读写分离
   1. 通过增加从服务器来提高数据库的性能，在主服务器上执行写入和更新，在从服务器上向外提供读功能；
   2. 可以动态地调整从服务器的数量，从而调整整个数据库的性能。
2. 冗余服务器，数据备份，高可用，提高数据安全

## 主从同步延时问题

MySQL 实际上在有**两个同步机制**：

- 一个是**半同步复制**，解决主库**数据丢失**问题
- 一个是**并行复制**，解决主从**同步延时**问题。

### 半同步复制

- 主库写入 binlog 日志后，强制立即将数据同步到从库；

- 从库将日志写入自己本地的 relay log 之后，接着会返回一个 ack 给主库；
- 主库接收到至少一个从库的 ack 之后认为写操作完成了。

### 并行复制（库级别的并行）

- 从库开启多个SQL线程，并行读取 relay log 中**不同库**的日志，然后并行重放不同库的日志，并发还原数据。