# 事务

## 1. 定义

事务(transaction)是将一组 SQL 语句逻辑地捆绑在一起，这些语句存在逻辑相关性，作为一个不可分割的工作单元。

**数据库事务**是指作为单个逻辑工作单元执行的一系列数据库操作（如插入、更新、删除等）。

这些操作要么全部成功执行，要么全部不执行，确保数据库从一个一致状态转换到另一个一致状态。

**银行转账示例**：

1. 你点击确认，银行系统从你的账户中扣除 1000 元。
2. 银行系统向收款人的账户中增加 1000 元。

如果步骤 1 成功了，但由于网络中断或断电，步骤 2 失败了，这 1000 元就会凭空消失。

事务的作用就是确保：要么这两个步骤都执行成功（Commit），要么如果其中任何一步失败，系统会自动撤销已执行的操作，让数据回到最初的状态（Rollback）。

------

## 2. 事务的四大特性 (ACID)

**原子性 (Atomicity)** 

- 事务是最小的操作单元。整个事务中的所有操作要么全部完成，要么全部不执行；
- 如果中途发生故障，已执行的操作会被回滚；
- 示例：银行转账中，扣款和入账必须同时成功或同时失败。

**一致性 (Consistency)** 

- 事务执行前后，数据库必须处于一致的状态，从一个有效状态转换到另一个有效状态；
- 保持所有预定义的数据完整性约束（主键、外键、业务规则等）；
- 示例：转账前后，两个账户的总额必须保持不变。

**隔离性 (Isolation)** 

- 并发执行的事务之间互不干扰；
- 每个事务感觉像是独立执行；
- 通过不同隔离级别（如读已提交、可重复读等）控制可见性。

**持久性 (Durability)** 

- 一旦事务提交，它对数据库中数据的改变就是永久性的，即使发生系统崩溃也不会丢失。

------

## 3. 事务的生命周期

在实际操作中，一个典型的事务流程如下表所示：

| **阶段**          | **说明**                                     |
| ----------------- | -------------------------------------------- |
| **BEGIN / START** | 明确告知数据库：接下来的操作属于同一个事务。 |
| **EXECUTE**       | 执行多条增、删、改的操作。                   |
| **COMMIT**        | 如果一切顺利，永久保存所有更改。             |
| **ROLLBACK**      | 如果中途出错，撤回所有已执行但未提交的操作。 |

```sql
-- 典型的事务控制语句
BEGIN TRANSACTION;  -- 开始事务

UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

COMMIT;  -- 提交事务，使更改永久化
-- 或
ROLLBACK;  -- 回滚事务，撤销所有更改
```

## 4. 实际应用场景

1. **金融交易**：银行转账
2. **订单处理**：库存减少与订单创建
3. **用户注册**：创建用户记录同时初始化配置
4. **批量数据导入**：多条数据要么全部导入，要么全部放弃

## 5. 事务的隔离级别（从低到高）

1. **读未提交**：可能读到其他事务未提交的数据
2. **读已提交**：只能读到已提交的数据（多数数据库默认）
3. **可重复读**：同一事务内多次读取结果一致
4. **串行化**：完全隔离，如同顺序执行

## 6. 事务可能遇到的问题

1. **脏读**：读取到未提交的数据
2. **不可重复读**：同一查询在不同时间返回不同结果
3. **幻读**：同一查询返回不同的行集合
4. **丢失更新**：并发更新导致某些更新被覆盖

## 7. 最佳实践建议

1. **尽量缩短事务时间**：减少锁竞争
2. **合理选择隔离级别**：平衡一致性与性能
3. **设计良好的错误处理机制**：确保异常时能正确回滚
4. **避免在事务中进行用户交互**：防止长时间持有锁
