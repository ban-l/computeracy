## MVCC的存储与清理

### 1. **版本存储策略**

```sql
-- PostgreSQL：新版本存储在堆表中
-- 表膨胀问题严重，需要定期VACUUM

-- 查看表膨胀情况
SELECT 
    schemaname,
    tablename,
    n_dead_tup,
    n_live_tup,
    round(n_dead_tup::numeric / (n_live_tup + n_dead_tup) * 100, 2) as dead_ratio
FROM pg_stat_user_tables
WHERE n_live_tup > 0
ORDER BY dead_ratio DESC;
```

### 2. **清理机制：VACUUM**

```sql
-- 手动执行VACUUM
VACUUM accounts;  -- 常规清理，不锁表
VACUUM FULL accounts;  -- 重写表，回收空间，锁表

-- 自动VACUUM配置
-- 查看配置
SELECT name, setting, unit FROM pg_settings 
WHERE name LIKE 'autovacuum%';

-- 关键配置：
-- autovacuum = on
-- autovacuum_vacuum_threshold = 50
-- autovacuum_vacuum_scale_factor = 0.2
-- autovacuum_vacuum_cost_delay = 20ms
```

### 3. **InnoDB的清理机制**

```sql
-- InnoDB：undo log清理
-- 查看undo配置
SHOW VARIABLES LIKE 'innodb_undo%';

-- 关键参数：
-- innodb_undo_tablespaces = 2
-- innodb_undo_logs = 128
-- innodb_purge_threads = 4

-- 监控undo使用
SELECT 
    NAME,
    SPACE_TYPE,
    FILE_SIZE/1024/1024 as size_mb,
    FREE_PAGES,
    NOT_FREE_PAGES
FROM information_schema.INNODB_TABLESPACES 
WHERE NAME LIKE '%undo%';
```

## 